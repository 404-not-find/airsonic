<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="schema43_001" author="muff1nman">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from version where version = 16</sqlCheck>
        </preConditions>
        <insert tableName="version">
            <column name="version" valueNumeric="16" />
        </insert>
        <rollback>
            <delete tableName="version" >
                <where>version = 16</where>
            </delete>
        </rollback>
    </changeSet>
    <changeSet id="schema43_002" author="muff1nman">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from version where version = 17</sqlCheck>
        </preConditions>
        <insert tableName="version">
            <column name="version" valueNumeric="17" />
        </insert>
        <delete tableName="transcoding">
            <where>target_format = 'mp4' and source_format in ('avi', 'mpg', 'mpeg', 'mp4', 'm4v', 'mkv', 'mov', 'wmv', 'ogv')</where>
        </delete>
        <insert tableName="transcoding">
            <column name="name" value="avi > mp4"/>
            <column name="source_format" value="avi" />
            <column name="target_format" value="mp4" />
            <column name="step1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f mp4 -vcodec libx264 -preset superfast -threads 0 -movflags frag_keyframe+empty_moov -" />
            <column name="enabled" valueBoolean="true" />
        </insert>
        <sql>
            insert into player_transcoding(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from player p, transcoding t where t.name = 'avi > mp4'
        </sql>
        <insert tableName="transcoding">
            <column name="name" value="mpg > mp4"/>
            <column name="source_format" value="mpg" />
            <column name="target_format" value="mp4" />
            <column name="step1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f mp4 -vcodec libx264 -preset superfast -threads 0 -movflags frag_keyframe+empty_moov -" />
            <column name="enabled" valueBoolean="true" />
        </insert>
        <sql>
            insert into player_transcoding(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from player p, transcoding t where t.name = 'mpg > mp4'
        </sql>
        <insert tableName="transcoding">
            <column name="name" value="mpeg > mp4"/>
            <column name="source_format" value="mpeg" />
            <column name="target_format" value="mp4" />
            <column name="step1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f mp4 -vcodec libx264 -preset superfast -threads 0 -movflags frag_keyframe+empty_moov -" />
            <column name="enabled" valueBoolean="true" />
        </insert>
        <sql>
            insert into player_transcoding(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from player p, transcoding t where t.name = 'mpeg > mp4'
        </sql>
        <insert tableName="transcoding">
            <column name="name" value="flv > mp4"/>
            <column name="source_format" value="flv" />
            <column name="target_format" value="mp4" />
            <column name="step1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f mp4 -vcodec libx264 -preset superfast -threads 0 -movflags frag_keyframe+empty_moov -" />
            <column name="enabled" valueBoolean="true" />
        </insert>
        <sql>
            insert into player_transcoding(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from player p, transcoding t where t.name = 'flv > mp4'
        </sql>
        <insert tableName="transcoding">
            <column name="name" value="m4v > mp4"/>
            <column name="source_format" value="m4v" />
            <column name="target_format" value="mp4" />
            <column name="step1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f mp4 -vcodec libx264 -preset superfast -threads 0 -movflags frag_keyframe+empty_moov -" />
            <column name="enabled" valueBoolean="true" />
        </insert>
        <sql>
            insert into player_transcoding(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from player p, transcoding t where t.name = 'm4v > mp4'
        </sql>
        <insert tableName="transcoding">
            <column name="name" value="mkv > mp4"/>
            <column name="source_format" value="mkv" />
            <column name="target_format" value="mp4" />
            <column name="step1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f mp4 -vcodec libx264 -preset superfast -threads 0 -movflags frag_keyframe+empty_moov -" />
            <column name="enabled" valueBoolean="true" />
        </insert>
        <sql>
            insert into player_transcoding(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from player p, transcoding t where t.name = 'mkv > mp4'
        </sql>
        <insert tableName="transcoding">
            <column name="name" value="mov > mp4"/>
            <column name="source_format" value="mov" />
            <column name="target_format" value="mp4" />
            <column name="step1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f mp4 -vcodec libx264 -preset superfast -threads 0 -movflags frag_keyframe+empty_moov -" />
            <column name="enabled" valueBoolean="true" />
        </insert>
        <sql>
            insert into player_transcoding(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from player p, transcoding t where t.name = 'mov > mp4'
        </sql>
        <insert tableName="transcoding">
            <column name="name" value="wmv > mp4"/>
            <column name="source_format" value="wmv" />
            <column name="target_format" value="mp4" />
            <column name="step1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f mp4 -vcodec libx264 -preset superfast -threads 0 -movflags frag_keyframe+empty_moov -" />
            <column name="enabled" valueBoolean="true" />
        </insert>
        <sql>
            insert into player_transcoding(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from player p, transcoding t where t.name = 'wmv > mp4'
        </sql>
        <insert tableName="transcoding">
            <column name="name" value="ogv > mp4"/>
            <column name="source_format" value="ogv" />
            <column name="target_format" value="mp4" />
            <column name="step1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f mp4 -vcodec libx264 -preset superfast -threads 0 -movflags frag_keyframe+empty_moov -" />
            <column name="enabled" valueBoolean="true" />
        </insert>
        <sql>
            insert into player_transcoding(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from player p, transcoding t where t.name = 'ogv > mp4'
        </sql>
        <rollback/>
    </changeSet>
    <changeSet id="schema43_003" author="muff1nman">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="user" columnName="email" />
            </not>
        </preConditions>
        <addColumn tableName="user">
            <column name="email" type="${varchar_type}"/>
        </addColumn>
    </changeSet>
</databaseChangeLog>
